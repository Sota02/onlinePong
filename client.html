<!DOCTYPE html>
<!--https://developer.mozilla.org/en-US/docs/Games/Tutorials/2D_Breakout_game_pure_JavaScript-->
<html>
<head>
    <meta http-equiv="content-type" content="text/html charset=UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <title>Online Pong!</title>
    <link rel="stylesheet" href="forClient.css" />
    <link href="https://fonts.googleapis.com/css?family=Orbitron" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
</head>
<body>

  <!--canvas and buttons-->
  <div id="canvasButtons">
    <canvas id="myCanvas" width="480" height="540"></canvas>
    <div class="gameButtons" align="center">
        <input type="button" id="btnStart" value="Start" onclick="btnStart()" />
        <input type="button" id="btnPause" disabled="disabled" value="Pause" onclick="btnPause()" />
        <input type="button" id="btnReset" disabled="disabled" value="Reset" onclick="btnReset()" />
    </div>
  </div>
  <!--entry form-->

<div id="outerForm" align="center">
<form class="form-inline">
  <div class="form-group">
      <label class="roomLabel" for="rooms">Rooms：</label>
      <select class="form-control" id="rooms">
          <option value="room01">Room01</option>
          <option value="room02">Room02</option>
      </select>
      <label class="nameLabel" for="msgForm">Name：</label>
      <input type="text" class="form-control" id="msgForm">
      <button type="submit" class="btn btn-primary" id="sendButton">Enter</button>
  </div>

</form>
</div>

<!--system and chat message for a winner-->
<div id="systemMessage" align="center"></div>

<script>
document.getElementById("canvasButtons").style.display="none";
var isEnter = false;
var name = '';
var chosenRoom = '';
function changeLabel() {
            $(".nameLabel").text("Message：");
            $("#rooms").prop("disabled", true);
            $("button").text("send");
            isEnter = true;
}
$("form").submit(function(e) {
            var message = $("#msgForm").val();
            chosenRoom = $("#rooms").val();
            $("#msgForm").val('');
            if (isEnter) {
              message = name + ": " + message;
                // send chat message
                socket.emit("client_to_server_chat", {value : message});
            } else {
                name = message;
                socket.emit("client_to_server_join", {value : chosenRoom,clientName:message});
                changeLabel();
            }
            document.getElementById("canvasButtons").style.display="block";
            e.preventDefault();
        });

const socket = io(); //to communicate with server via socket.io
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
var canvasMessage = '';

class Player{
   constructor(){
    this.name = '';
    this.playerNumber = '';
  }
}
class Ball{
  constructor(color){
    this.radius = 10;
    this.positionX = 0;
    this.positionY = 0;
    this.color = color;
  }
}
class Paddle{
   constructor(positionX,positionY,color){
     this.height = 10;
     this.width = 65;
     this.positionX = positionX;
     this.positionY = positionY;
     this.color = color;
   }
}
var player = new Player();
var ball1 = new Ball('#AAAAAA');
var paddle1 = new Paddle(0,canvas.height - 10,'#0095DD');//blue
var paddle2 = new Paddle(0,0,'#DD4800');//red
var paddle3 = new Paddle(0,canvas.height - 10,'#00AA00');//green
var paddle4 = new Paddle(0,0,'#FFABCE')//pink

//score
var scoreBlue = 0;
var scoreRed = 0;

//Control cursor keys
document.addEventListener("keydown", keyDownHandler, false);
document.addEventListener("keyup", keyUpHandler, false);

function keyDownHandler(e) {
    if(e.keyCode == 39) {
        socket.emit("rightKeyDown",{room:chosenRoom,value:player.playerNumber});
    }
    else if(e.keyCode == 37) {
        socket.emit("leftKeyDown",{room:chosenRoom,value:player.playerNumber});
    }
}
function keyUpHandler(e) {
    if(e.keyCode == 39) {
        socket.emit("rightKeyUp",{room:chosenRoom,value:player.playerNumber});
    }
    else if(e.keyCode == 37) {
        socket.emit("leftKeyUp",{room:chosenRoom,value:player.playerNumber});
    }
}

//draw objects
function drawBall(ball) {
    ctx.beginPath();
    ctx.arc(ball.positionX, ball.positionY, ball.radius, 0, Math.PI*2);
    ctx.fillStyle = ball.color;
    ctx.fill();
    ctx.closePath();
}
function drawPaddle(paddle) {
    ctx.beginPath();
    ctx.rect(paddle.positionX, paddle.positionY, paddle.width, paddle.height);
    ctx.fillStyle = paddle.color;
    ctx.fill();
    ctx.closePath();
}
function drawScore(){
    ctx.font = "14px Orbitron";
    ctx.fillStyle = "#0095DD";
    ctx.fillText("P1(Blue) & P3(Green): "+scoreBlue,8,25);
    ctx.fillStyle = "#DD4800";
    ctx.fillText("P2(Red) & P3(Pink): "+scoreRed,8,45);
}
function drawCanvasMessage(){
  if(canvasMessage==='Start'){
    ctx.font = "120px Orbitron";
    ctx.fillStyle = "#DDDDDD";
    ctx.fillText(canvasMessage,80,300);
  }
  else if(canvasMessage==='Pause'){
    ctx.font = "100px Orbitron";
    ctx.fillStyle = "#DDDDDD";
    ctx.fillText(canvasMessage,80,300);
  }else{ //When Game is over
    ctx.font = "26px Orbitron";
    ctx.fillStyle = "#0095DD";
    ctx.fillText(canvasMessage,25,300);
  }
}
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    socket.emit("getCoordinates",{value:chosenRoom});
    socket.on('setCoordinates', function (data) {
       ball1.positionX = data.positionX;
       ball1.positionY = data.positionY;
       paddle1.positionX = data.paddleX;
       paddle2.positionX = data.paddleX2;
       paddle3.positionX = data.paddleX3;
       paddle4.positionX = data.paddleX4;
    });
    drawCanvasMessage();
    drawBall(ball1);
    drawPaddle(paddle1);
    drawPaddle(paddle2);
    drawPaddle(paddle3);
    drawPaddle(paddle4);
    drawScore();
    requestAnimationFrame(draw);
}

//Get playerNumber
socket.on('setPlayerNumber',function(data){
  player.playerNumber = data.value;
});

//Start Button
function btnStart(){
    socket.emit("getStart",{value:chosenRoom});
    if(canvasMessage===''){
        canvasMessage='Start';
    }
    else{ //canvasMessage === "Pause" or "player1 won"
        canvasMessage='';
    }
    function deleteCanvasMessage(){
      if(canvasMessage==='Start'){
          canvasMessage='';
      }
    }
    setTimeout(deleteCanvasMessage,2000);
}
socket.on('setStart', function (data) {
    scoreBlue = data.scoreBlue;
    scoreRed = data.scoreRed;
    document.getElementById("btnStart").disabled = "disabled";
    document.getElementById("btnPause").disabled = "";
    document.getElementById("btnReset").disabled = "";
    draw();
});
function btnPause(){
    socket.emit("getPause");
    canvasMessage='Pause';
}
socket.on('setPause', function () {
    document.getElementById("btnPause").disabled = "disabled";
    document.getElementById("btnStart").disabled = "";
});
function btnReset(){
    socket.emit("getReset",{value:chosenRoom});
    canvasMessage='';
}
//Receive System message from server
socket.on('showSystemMessage', function (data) {
  $("#systemMessage").prepend("<div>" + data.value + "</div>");
});
socket.on('showCanvasMessage', function (data) {
  console.log(data.value);
  canvasMessage = data.value;
});
//score
socket.on('renewScore', function (data) {
    scoreBlue = data.scoreBlue;
    scoreRed = data.scoreRed;
});
</script>

</body>
</html>
